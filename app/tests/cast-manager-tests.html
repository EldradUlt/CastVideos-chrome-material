<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport"
        content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>cast-manager-tests</title>
  <script src="../../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <!--<script>-->
    <!--WCT = {-->
      <!--environmentScripts: [-->
        <!--// Mocha and Stacky are required dependencies-->
        <!--'stacky/lib/parsing.js',-->
        <!--'stacky/lib/formatting.js',-->
        <!--'stacky/lib/normalization.js',-->
        <!--'mocha/mocha.js',-->
        <!--'https://www.gstatic.com/cv/js/sender/v1/cast_sender.js'-->
        <!--// Include anything else that you like!-->
      <!--];-->
    <!--};-->

  <!--</script>-->
  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <script src="../../bower_components/should/should.js"></script>

  <script src="../../bower_components/test-fixture/test-fixture-mocha.js"></script>

  <link rel="import" href="../../bower_components/test-fixture/test-fixture.html">

  <link rel="import" href="../../bower_components/cast-manager-polymer/cast-manager.html">
  <link rel="import" href="../../bower_components/cast-video-polymer/cast-video.html">


</head>
<body>
<!--<test-fixture id="basic">-->
  <template id="t" is="dom-bind">
    <cast-manager app-id="4F8B3483"
                  cast-available="{{castAvailable}}"
                  connection-status="{{connectionStatus}}"
                  local-media="{{localMedia}}"
                  queue="{{queue}}"
                  volume="{{volume}}"
                  has-cast-media="{{hasCastMedia}}"
                  is-queue-shown="{{isQueueShown}}"
                  cast-device-name="{{castDeviceName}}"
                  current-time="{{currentTime}}"
                  is-fullscreen="{{isFullscreen}}"
                  show-spinner="{{showSpinner}}"
                  next-queue-media-item="{{nextQueueMediaItem}}"
                  countdown-to-next-media-item="{{countdownToNextMediaItem}}">
      <div style="height:720px;width:1280px;">
        <cast-video id="video"
                    local-media="{{localMedia}}"
                    volume="{{volume}}"
                    current-time="{{currentTime}}"
                    is-fullscreen="{{isFullscreen}}"
                    queue="[[queue]]"
                    cast-available="[[castAvailable]]"
                    connection-status="[[connectionStatus]]"
                    show-spinner="[[showSpinner]]"
                    cast-device-name="[[castDeviceName]]"></cast-video>
      </div>
    </cast-manager>
  </template>
<!--</test-fixture>-->
<script>
  var media = {
    "categories": [{
      "name": "Movies",
      "videos": [
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/DesigningForGoogleCast.mp4"],
          "thumb": "images/DesigningForGoogleCast-480x270.jpg",
          "image-480x270": "images_480x270/DesigningForGoogleCast2-480x270.jpg",
          "image-780x1200": "images_780x1200/DesigningForGoogleCast-887x1200.jpg",
          "title": "Designing For Google Cast",
          "studio": "Google IO - 2014",
          "tracks": [{
            "id": "1",
            "type": "text",
            "subtype": "captions",
            "contentId": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/DesigningForGoogleCast-en.vtt",
            "name": "English Subtitle",
            "language": "en-US"
          }]
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/GoogleIO-2014-CastingToTheFuture.mp4"],
          "thumb": "images/ToTheFuture-480x270.jpg",
          "image-480x270": "images_480x270/ToTheFuture2-480x270.jpg",
          "image-780x1200": "images_780x1200/ToTheFuture-789x1200.jpg",
          "title": "Casting To The Future",
          "studio": "Google IO - 2014",
          "tracks": [{
            "id": "1",
            "type": "text",
            "subtype": "captions",
            "contentId": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/GoogleIO-2014-CastingToTheFuture2-en.vtt",
            "name": "English Subtitle",
            "language": "en-US"
          }]
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/GoogleIO-2014-MakingGoogleCastReadyAppsDiscoverable.mp4"],
          "thumb": "images/MakingGoogleCastReadyAppsDiscoverable-480-270.jpg",
          "image-480x270": "images_480x270/MakingGoogleCastReadyAppsDiscoverable-480-270.jpg",
          "image-780x1200": "images_780x1200/MakingGoogleCastReadyAppsDiscoverable-852-1200.jpg",
          "title": "Making Cast Ready Apps Discoverable",
          "studio": "Google IO - 2014",
          "tracks": [{
            "id": "1",
            "type": "text",
            "subtype": "captions",
            "contentId": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/GoogleIO-2014-MakingGoogleCastReadyAppsDiscoverable-en.vtt",
            "name": "English Subtitle",
            "language": "en-US"
          }]
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"],
          "thumb": "images/BigBuckBunny.jpg",
          "image-480x270": "images_480x270/BigBuckBunny.jpg",
          "image-780x1200": "images_780x1200/BigBuckBunny-780x1200.jpg",
          "title": "Big Buck Bunny",
          "studio": "Blender Foundation"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4"],
          "thumb": "images/ElephantsDream.jpg",
          "image-480x270": "images_480x270/ElephantsDream.jpg",
          "image-780x1200": "images_780x1200/ElephantsDream-780x1200.jpg",
          "title": "Elephant Dream",
          "studio": "Blender Foundation"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4"],
          "thumb": "images/ForBiggerBlazes.jpg",
          "image-480x270": "images_480x270/ForBiggerBlazes.jpg",
          "image-780x1200": "images_780x1200/Blaze-780x1200.jpg",
          "title": "For Bigger Blazes",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4"],
          "thumb": "images/ForBiggerEscapes.jpg",
          "image-480x270": "images_480x270/ForBiggerEscapes.jpg",
          "image-780x1200": "images_780x1200/Escape-780x1200.jpg",
          "title": "For Bigger Escape",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4"],
          "thumb": "images/ForBiggerFun.jpg",
          "image-480x270": "images_480x270/ForBiggerFun.jpg",
          "image-780x1200": "images_780x1200/Fun-780x1200.jpg",
          "title": "For Bigger Fun",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4"],
          "thumb": "images/ForBiggerJoyrides.jpg",
          "image-480x270": "images_480x270/ForBiggerJoyrides.jpg",
          "image-780x1200": "images_780x1200/Joyride-780x1200.jpg",
          "title": "For Bigger Joyrides",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4"],
          "thumb": "images/ForBiggerMeltdowns.jpg",
          "image-480x270": "images_480x270/ForBiggerMeltdowns.jpg",
          "image-780x1200": "images_780x1200/Meltdown-780x1200.jpg",
          "title": "For Bigger Meltdowns",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4"],
          "thumb": "images/Sintel.jpg",
          "image-480x270": "images_480x270/Sintel.jpg",
          "image-780x1200": "images_780x1200/Sintel-780x1200.jpg",
          "title": "Sintel",
          "studio": "Blender Foundation"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/SubaruOutbackOnStreetAndDirt.mp4"],
          "thumb": "images/SubaruOutbackOnStreetAndDirt.jpg",
          "image-480x270": "images_480x270/SubaruOutbackOnStreetAndDirt.jpg",
          "image-780x1200": "images_780x1200/Subaru-780x1200.jpg",
          "title": "Subaru Outback On Street And Dirt",
          "studio": "Garage419"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4"],
          "thumb": "images/TearsOfSteel.jpg",
          "image-480x270": "images_480x270/TearsOfSteel.jpg",
          "image-780x1200": "images_780x1200/TearsOfSteel-780x1200.jpg",
          "title": "Tears of Steel",
          "studio": "Blender Foundation"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/VolkswagenGTIReview.mp4"],
          "thumb": "images/VolkswagenGTIReview.jpg",
          "image-480x270": "images_480x270/VolkswagenGTIReview.jpg",
          "image-780x1200": "images_780x1200/VolksWagen-780x1200.jpg",
          "title": "Volkswagen GTI Review",
          "studio": "Garage419"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WeAreGoingOnBullrun.mp4"],
          "thumb": "images/WeAreGoingOnBullrun.jpg",
          "image-480x270": "images_480x270/WeAreGoingOnBullrun.jpg",
          "image-780x1200": "images_780x1200/Bullrun-780x1200.jpg",
          "title": "We Are Going On Bullrun",
          "studio": "Garage419"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WhatCarCanYouGetForAGrand.mp4"],
          "thumb": "images/WhatCarCanYouGetForAGrand.jpg",
          "image-480x270": "images_480x270/WhatCarCanYouGetForAGrand.jpg",
          "image-780x1200": "images_780x1200/grand-780x1200.jpg",
          "title": "What care can you get for a grand?",
          "studio": "Garage419"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Google_I_O_2013_Keynote.mp4"],
          "thumb": "images/WhatCarCanYouGetForAGrand.jpg",
          "image-480x270": "images_480x270/Google_I_O_2013_Keynote-480x270.jpg",
          "image-780x1200": "images_780x1200/Google_I_O_2013_Keynote-780x1200.jpg",
          "title": "Google I/O Keynote 2013",
          "studio": "Google"
        }
      ]
    }]
  };
  var ROOT = '//commondatastorage.googleapis.com/gtv-videos-bucket/sample/';
  var processedMediaArray = processMedia(media.categories[0].videos);

  function processMedia(media) {
    var mediaArray = [];
    for (var i = 0; i < media.length; i++) {
      mediaArray.push({
        'title': media[i].title,
        'description': media[i].subtitle,
        'url': media[i].sources[0],
        'studio': media[i].studio,
        'thumbnailImageUrl': ROOT + media[i]['image-480x270'],
        'largeImageUrl': ROOT + media[i]['image-780x1200']
      });
    }
    return mediaArray;
  }

  var castManager, castVideo;

  var t = document.querySelector('#t');

  if(document.querySelector('cast-manager')) {
    castManager = document.querySelector('cast-manager');
    castVideo = document.querySelector('cast-video');
    done();
  } else {
    t.addEventListener('dom-change', function () {
      castManager = document.querySelector('cast-manager');
      castVideo = document.querySelector('cast-video');
    });
  }

  describe('castManager', function () {

//    before(function (done) {
//      //fixture('basic');
//
//
//    });

    describe('queue', function () {
      it('should include 17 items after insert', function () {
        castManager.addItemsToQueue(processedMediaArray);
        castManager.queue.getLength().should.equal(17);
      });

      it('getCurrentItem returns the first item in queue', function () {
        var firstItem = castManager.queue.getCurrentItem();
        firstItem.title.should.equal(processedMediaArray[0].title);
      });

      it('peekNextItem returns the second item in queue but does not change getCurrentItem or getNextItem',
          function () {
            var secondItem = castManager.queue.peekNextItem();
            secondItem.title.should.equal(processedMediaArray[1].title);

            var firstItem = castManager.queue.getCurrentItem();
            firstItem.title.should.equal(processedMediaArray[0].title);

            secondItem = castManager.queue.getNextItem();
            secondItem.title.should.equal(processedMediaArray[1].title);
          });

      it('getNextItem returns the second item in queue', function () {
        var secondItem = castManager.queue.getNextItem();
      });

      it('should include 0 items after empty and current item should be null', function () {
        castManager.queue.empty();
        castManager.queue.getLength().should.equal(0);
        Should.not.exist(castManager.queue.getCurrentItem());
      });
    });

    describe('local video playback', function() {
      it('should play', function(done) {
        castManager.play();
        setTimeout(function() {
          castManager.localMedia.state.should.equal(cast.MediaItem.STATE.PLAYING);
          done();
        }, 1000);
      });

      it('should seek', function(done) {
        castManager.seek(50);
        setTimeout(function() {
          castManager.currentTime.should.be.above(50);
          done();
        }, 1000)
      });

      it('should pause', function(done) {
        castManager.pause();
        setTimeout(function() {
          castManager.localMedia.state.should.equal(cast.MediaItem.STATE.PAUSED);
          done();
        }, 1000);
      });
    });

    describe('cast', function () {
      this.timeout(60000);
      if (window.chrome !== null
          && window.chrome !== undefined
          && window.navigator.vendor === 'Google Inc.') {

        it('queue should include 17 items again after second media insertion insert', function () {
          castManager.addItemsToQueue(processedMediaArray);
          castManager.queue.getLength().should.equal(17);
        });

        it('connect', function (done) {
          console.log(chrome.cast);
          setTimeout(function () {
            castManager.startCast();
            setTimeout(function () {
              castManager.connectionStatus.should.equal(cast.CastManager.CONNECTION_STATUS.CONNECTED);
              done();
            }, 20000);
          }, 3000);
        });

        it('disconnect', function(done) {
          castManager.stopCasting();
          setTimeout(function() {
            castManager.connectionStatus.should.equal(cast.CastManager.CONNECTION_STATUS.DISCONNECTED);
            done();
          }, 5000);
        });
      }
    });
  });
</script>

</body>
</html>