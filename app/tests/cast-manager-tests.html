<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport"
        content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>cast-manager-tests</title>
  <script src="../../bower_components/webcomponentsjs/webcomponents.min.js"></script>

  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <script src="../../bower_components/should/should.js"></script>

  <script src="../../bower_components/test-fixture/test-fixture-mocha.js"></script>

  <link rel="import" href="../../bower_components/test-fixture/test-fixture.html">

  <link rel="import" href="../../bower_components/cast-manager-polymer/cast-manager.html">
  <link rel="import" href="../../bower_components/cast-video-polymer/cast-video.html">


</head>
<body>
  <template id="t" is="dom-bind">
    <cast-manager app-id="4F8B3483"
                  cast-available="{{castAvailable}}"
                  connection-status="{{connectionStatus}}"
                  local-media="{{localMedia}}"
                  queue="{{queue}}"
                  volume="{{volume}}"
                  has-cast-media="{{hasCastMedia}}"
                  is-queue-shown="{{isQueueShown}}"
                  cast-device-name="{{castDeviceName}}"
                  current-time="{{currentTime}}"
                  is-fullscreen="{{isFullscreen}}"
                  show-spinner="{{showSpinner}}"
                  next-queue-media-item="{{nextQueueMediaItem}}"
                  countdown-to-next-media-item="{{countdownToNextMediaItem}}">
      <div style="height:720px;width:1280px;">
        <cast-video id="video"
                    local-media="{{localMedia}}"
                    volume="{{volume}}"
                    current-time="{{currentTime}}"
                    is-fullscreen="{{isFullscreen}}"
                    queue="[[queue]]"
                    cast-available="[[castAvailable]]"
                    connection-status="[[connectionStatus]]"
                    show-spinner="[[showSpinner]]"
                    cast-device-name="[[castDeviceName]]"></cast-video>
      </div>
    </cast-manager>
  </template>
<script>
  var media = {
    "categories": [{
      "name": "Movies",
      "videos": [
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/DesigningForGoogleCast.mp4"],
          "thumb": "images/DesigningForGoogleCast-480x270.jpg",
          "image-480x270": "images_480x270/DesigningForGoogleCast2-480x270.jpg",
          "image-780x1200": "images_780x1200/DesigningForGoogleCast-887x1200.jpg",
          "title": "Designing For Google Cast",
          "studio": "Google IO - 2014",
          "tracks": [{
            "id": "1",
            "type": "text",
            "subtype": "captions",
            "contentId": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/DesigningForGoogleCast-en.vtt",
            "name": "English Subtitle",
            "language": "en-US"
          }]
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/GoogleIO-2014-CastingToTheFuture.mp4"],
          "thumb": "images/ToTheFuture-480x270.jpg",
          "image-480x270": "images_480x270/ToTheFuture2-480x270.jpg",
          "image-780x1200": "images_780x1200/ToTheFuture-789x1200.jpg",
          "title": "Casting To The Future",
          "studio": "Google IO - 2014",
          "tracks": [{
            "id": "1",
            "type": "text",
            "subtype": "captions",
            "contentId": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/GoogleIO-2014-CastingToTheFuture2-en.vtt",
            "name": "English Subtitle",
            "language": "en-US"
          }]
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/GoogleIO-2014-MakingGoogleCastReadyAppsDiscoverable.mp4"],
          "thumb": "images/MakingGoogleCastReadyAppsDiscoverable-480-270.jpg",
          "image-480x270": "images_480x270/MakingGoogleCastReadyAppsDiscoverable-480-270.jpg",
          "image-780x1200": "images_780x1200/MakingGoogleCastReadyAppsDiscoverable-852-1200.jpg",
          "title": "Making Cast Ready Apps Discoverable",
          "studio": "Google IO - 2014",
          "tracks": [{
            "id": "1",
            "type": "text",
            "subtype": "captions",
            "contentId": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/GoogleIO-2014-MakingGoogleCastReadyAppsDiscoverable-en.vtt",
            "name": "English Subtitle",
            "language": "en-US"
          }]
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"],
          "thumb": "images/BigBuckBunny.jpg",
          "image-480x270": "images_480x270/BigBuckBunny.jpg",
          "image-780x1200": "images_780x1200/BigBuckBunny-780x1200.jpg",
          "title": "Big Buck Bunny",
          "studio": "Blender Foundation"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4"],
          "thumb": "images/ElephantsDream.jpg",
          "image-480x270": "images_480x270/ElephantsDream.jpg",
          "image-780x1200": "images_780x1200/ElephantsDream-780x1200.jpg",
          "title": "Elephant Dream",
          "studio": "Blender Foundation"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4"],
          "thumb": "images/ForBiggerBlazes.jpg",
          "image-480x270": "images_480x270/ForBiggerBlazes.jpg",
          "image-780x1200": "images_780x1200/Blaze-780x1200.jpg",
          "title": "For Bigger Blazes",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4"],
          "thumb": "images/ForBiggerEscapes.jpg",
          "image-480x270": "images_480x270/ForBiggerEscapes.jpg",
          "image-780x1200": "images_780x1200/Escape-780x1200.jpg",
          "title": "For Bigger Escape",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4"],
          "thumb": "images/ForBiggerFun.jpg",
          "image-480x270": "images_480x270/ForBiggerFun.jpg",
          "image-780x1200": "images_780x1200/Fun-780x1200.jpg",
          "title": "For Bigger Fun",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4"],
          "thumb": "images/ForBiggerJoyrides.jpg",
          "image-480x270": "images_480x270/ForBiggerJoyrides.jpg",
          "image-780x1200": "images_780x1200/Joyride-780x1200.jpg",
          "title": "For Bigger Joyrides",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4"],
          "thumb": "images/ForBiggerMeltdowns.jpg",
          "image-480x270": "images_480x270/ForBiggerMeltdowns.jpg",
          "image-780x1200": "images_780x1200/Meltdown-780x1200.jpg",
          "title": "For Bigger Meltdowns",
          "studio": "Google"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4"],
          "thumb": "images/Sintel.jpg",
          "image-480x270": "images_480x270/Sintel.jpg",
          "image-780x1200": "images_780x1200/Sintel-780x1200.jpg",
          "title": "Sintel",
          "studio": "Blender Foundation"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/SubaruOutbackOnStreetAndDirt.mp4"],
          "thumb": "images/SubaruOutbackOnStreetAndDirt.jpg",
          "image-480x270": "images_480x270/SubaruOutbackOnStreetAndDirt.jpg",
          "image-780x1200": "images_780x1200/Subaru-780x1200.jpg",
          "title": "Subaru Outback On Street And Dirt",
          "studio": "Garage419"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4"],
          "thumb": "images/TearsOfSteel.jpg",
          "image-480x270": "images_480x270/TearsOfSteel.jpg",
          "image-780x1200": "images_780x1200/TearsOfSteel-780x1200.jpg",
          "title": "Tears of Steel",
          "studio": "Blender Foundation"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/VolkswagenGTIReview.mp4"],
          "thumb": "images/VolkswagenGTIReview.jpg",
          "image-480x270": "images_480x270/VolkswagenGTIReview.jpg",
          "image-780x1200": "images_780x1200/VolksWagen-780x1200.jpg",
          "title": "Volkswagen GTI Review",
          "studio": "Garage419"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WeAreGoingOnBullrun.mp4"],
          "thumb": "images/WeAreGoingOnBullrun.jpg",
          "image-480x270": "images_480x270/WeAreGoingOnBullrun.jpg",
          "image-780x1200": "images_780x1200/Bullrun-780x1200.jpg",
          "title": "We Are Going On Bullrun",
          "studio": "Garage419"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WhatCarCanYouGetForAGrand.mp4"],
          "thumb": "images/WhatCarCanYouGetForAGrand.jpg",
          "image-480x270": "images_480x270/WhatCarCanYouGetForAGrand.jpg",
          "image-780x1200": "images_780x1200/grand-780x1200.jpg",
          "title": "What care can you get for a grand?",
          "studio": "Garage419"
        },
        {
          "subtitle": "Fusce id nisi turpis. Praesent viverra bibendum semper. Donec tristique, orci sed semper lacinia, quam erat rhoncus massa, non congue tellus est quis tellus. Sed mollis orci venenatis quam scelerisque accumsan. Curabitur a massa sit amet mi accumsan mollis sed et magna. Vivamus sed aliquam risus. Nulla eget dolor in elit facilisis mattis. Ut aliquet luctus lacus. Phasellus nec commodo erat. Praesent tempus id lectus ac scelerisque. Maecenas pretium cursus lectus id volutpat.",
          "sources": ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Google_I_O_2013_Keynote.mp4"],
          "thumb": "images/WhatCarCanYouGetForAGrand.jpg",
          "image-480x270": "images_480x270/Google_I_O_2013_Keynote-480x270.jpg",
          "image-780x1200": "images_780x1200/Google_I_O_2013_Keynote-780x1200.jpg",
          "title": "Google I/O Keynote 2013",
          "studio": "Google"
        }
      ]
    }]
  };
  var ROOT = '//commondatastorage.googleapis.com/gtv-videos-bucket/sample/';
  var processedMediaArray = processMedia(media.categories[0].videos);

  function processMedia(media) {
    var mediaArray = [];
    for (var i = 0; i < media.length; i++) {
      mediaArray.push({
        'title': media[i].title,
        'description': media[i].subtitle,
        'url': media[i].sources[0],
        'studio': media[i].studio,
        'thumbnailImageUrl': ROOT + media[i]['image-480x270'],
        'largeImageUrl': ROOT + media[i]['image-780x1200']
      });
    }
    return mediaArray;
  }

  var castManager, castVideo, castPlayerBar;

  var t = document.querySelector('#t');

  if(document.querySelector('cast-manager')) {
    castManager = document.querySelector('cast-manager');
    castVideo = document.querySelector('cast-video');
    done();
  } else {
    t.addEventListener('dom-change', function () {
      castManager = document.querySelector('cast-manager');
      castVideo = document.querySelector('cast-video');
      castPlayerBar = document.querySelector('cast-player-bar');
    });
  }

  describe('castManager', function () {

    before(function (done) {
      var checkIfCastIsLoaded = function() {
        if (window.chrome && window.navigator.vendor === 'Google Inc.' && !chrome.cast)
          setTimeout(checkIfCastIsLoaded, 1000);
        else {
          done();
        }
      };

      checkIfCastIsLoaded();
    });

    describe('queue', function () {
      it('should include 17 items after insert', function () {
        castManager.addItemsToQueue(processedMediaArray);
        castManager.queue.getLength().should.equal(17);
      });

      it('getCurrentItem returns the first item in queue', function () {
        var firstItem = castManager.queue.getCurrentItem();
        firstItem.title.should.equal(processedMediaArray[0].title);
      });

      it('peekNextItem returns the second item in queue but does not change getCurrentItem or getNextItem',
          function () {
            var secondItem = castManager.queue.peekNextItem();
            secondItem.title.should.equal(processedMediaArray[1].title);

            var firstItem = castManager.queue.getCurrentItem();
            firstItem.title.should.equal(processedMediaArray[0].title);

            secondItem = castManager.queue.getNextItem();
            secondItem.title.should.equal(processedMediaArray[1].title);
          });

      it('getNextItem returns the second item in queue', function () {
        var secondItem = castManager.queue.getNextItem();
      });

      it('queue should include 0 items after empty and current item should be null', function () {
        castManager.queue.empty();
        castManager.queue.getLength().should.equal(0);
        Should.not.exist(castManager.queue.getCurrentItem());
      });
    });

    describe('local video playback', function() {
      it('play should play the media', function() {
        castManager.play();
        castManager.localMedia.state.should.equal(cast.MediaItem.STATE.PLAYING);
      });

      it('seek 50 should seek to 50 seconds', function() {
        castManager.seek(50);
        castManager.currentTime.should.be.above(49);
      });

      it('pause should set state pause', function() {
        castManager.pause();
        castManager.localMedia.state.should.equal(cast.MediaItem.STATE.PAUSED);
      });

      it('setVolume 0 should change volume to 0', function() {
        castManager.setVolume(0);
        castManager.volume.should.equal(0);
      });
    });

    describe('media insertion and queue manipulation', function() {
      before(function () {
        //Preload items into queue
        castManager.addItemsToQueue(processedMediaArray);
      });

      it('queuePlayItem should update currentIndex and play specific item', function() {
        castManager.queuePlayItem(castManager.queue.items[5]);
        castManager.queue.getCurrentItem().should.equal(castManager.queue.items[5]);
        castManager.localMedia.url.should.equal(castManager.queue.items[5].url);
      });

      it('playNow should insert the item at the correct position in the queue', function() {
        castManager.queue.getLength().should.equal(17);
        castManager.queue.currentIndex.should.equal(5);
        castManager.playNow(processedMediaArray[2]);
        castManager.queue.currentIndex.should.equal(5);
        castManager.queue.getLength().should.equal(18);
        castManager.localMedia.url.should.equal(processedMediaArray[2].url);
      });

      it('playNext should insert the item at the correct position in the queue', function() {
        castManager.queue.currentIndex.should.equal(5);
        castManager.playNext(processedMediaArray[3]);
        castManager.queue.peekNextItem().url.should.equal(processedMediaArray[3].url);
      });

      it('addItemToQueue inserts it at the end of the queue', function() {
        castManager.addItemsToQueue([processedMediaArray[4]]);
        castManager.queue.items[castManager.queue.getLength()-1].url.should.equal(processedMediaArray[4].url);
      });

      it('queueMoveItemToNewIndex moves an item to a new index', function() {
        var currentItem = castManager.queue.getCurrentItem();
        castManager.queueMoveItemToNewIndex(currentItem.queueId, 0);
        castManager.queue.items[0].url.should.equal(currentItem.url);
      });

      it('queueLoadNextItem should load the next item in the queue', function() {
        var nextItem = castManager.queue.peekNextItem();
        castManager.queueLoadNextItem();
        castManager.queue.getCurrentItem().should.equal(nextItem);
      });
    });

    describe('player bar functions as expected', function() {
      var playbutton, currentTime;
      before(function() {
        playButton = castPlayerBar.$.button_play_pause;
        currentTime = castPlayerBar.$.label_time.children[0];
      });

      it('play/pause button click should play video', function() {
        playButton.click();
        castManager.localMedia.state.should.equal(cast.MediaItem.STATE.PLAYING);
      });

      it('play/pause button second click should pause video', function() {
        playButton.click();
        castManager.localMedia.state.should.equal(cast.MediaItem.STATE.PAUSED);
      });

      it('time integer to string renders correctly', function() {
        castManager.set('currentTime', 61);
        currentTime.innerText.should.equal('0:01:01');
      });

    });

    describe('cast to local converters', function() {

    });

    describe('local to cast converts', function() {

    });

    describe('cast connection and load', function () {
      this.timeout(180000);
      var castTimeout = 6500;
      var castLongTimeout = 15000;

      if (window.chrome !== null
          && window.chrome !== undefined
          && window.navigator.vendor === 'Google Inc.') {

        it('connect', function (done) {
          console.log(chrome.cast);
          setTimeout(function () {
            castManager.startCast();
            setTimeout(function () {
              castManager.connectionStatus.should.equal(cast.CastManager.CONNECTION_STATUS.CONNECTED);
              done();
            }, 15000);
          }, castTimeout);
        });

        it('isCasting returns true when casting', function() {
          castManager.isCasting().should.equal(true);
        });

        it('content should be playing or buffering', function(done) {
          setTimeout(function(){
            [chrome.cast.media.PlayerState.PLAYING, chrome.cast.media.PlayerState.BUFFERING].should.containEql(castManager.castMedia.playerState);
            done();
          }, castTimeout);
        });

        it('disconnect', function(done) {
          castManager.stopCasting();
          setTimeout(function() {
            castManager.connectionStatus.should.equal(cast.CastManager.CONNECTION_STATUS.DISCONNECTED);
            done();
          }, castTimeout);
        });

        it('post connection status check', function(){

        });

        describe('cast control tests', function() {
          before(function(done) {
            castManager.queue.empty();
            castManager.addItemsToQueue(processedMediaArray);
            castManager.startCast();
            setTimeout(function() {
              done();
            }, 15000);
          });

          it('pause should pause media', function(done) {
            castManager.pause();
            setTimeout(function() {
              castManager.castMedia.playerState.should.equal(chrome.cast.media.PlayerState.PAUSED);
              castManager.localMedia.state.should.equal(cast.MediaItem.STATE.PAUSED);
              done();
            }, castTimeout);
          });

          it('play should play media again', function(done) {
            castManager.play();
            setTimeout(function() {
              castManager.castMedia.playerState.should.equal(chrome.cast.media.PlayerState.PLAYING);
              castManager.localMedia.state.should.equal(cast.MediaItem.STATE.PLAYING);
              done();
            }, castTimeout);
          });
        });

        describe('cast queue insertion tests', function() {
          var firstItemToInsert, secondItemtoInsert, queueSize;
          before(function() {
            queueSize = castManager.queue.getLength();
            firstItemToInsert = processedMediaArray[2];
            secondItemToInsert = processedMediaArray[3];
          });

          it('queue size should match', function(done) {
            setTimeout(function() {
              castManager.castMedia.items.should.have.a.lengthOf(queueSize);
              done();
            }, castTimeout);
          });

          it('queueInsert should add an item at the end', function(done) {
            castManager.addItemsToQueue([firstItemToInsert]);
            setTimeout(function() {
              castManager.queue.items[castManager.queue.getLength()-1].url.should.equal(firstItemToInsert.url);
              done();
            }, castTimeout)
          });

          it('playNext should add an item as the next element', function(done) {
            castManager.playNext(secondItemToInsert);
            setTimeout(function() {
              castManager.queue.peekNextItem().url.should.equal(secondItemToInsert.url);
              done();
            }, castTimeout);
          });

          it('video inserted as next video should play next after seek to current video duration', function(done) {
            castManager.seek(castManager.localMedia.duration);
            setTimeout(function() {
              castManager.castMedia.media.contentId.should.equal(secondItemToInsert.url);
              done();
            }, castLongTimeout);
          });

          it('queuePlayItem second item should play the second item', function(done) {
            castManager.queuePlayItem(castManager.queue.items[1], function(msg) {
              console.log(JSON.stringify(msg));
              //TODO(pying): fix this after filing bug.  Success callback occurs before media is updated
              window.setTimeout(function() {
                castManager.queue.getCurrentItem().url.should.equal(castManager.queue.items[1].url);
                done();
              }, castLongTimeout);
            });
          });

          it('playNow should insert the video and play it', function(done) {
            var currentIndex = castManager.queue.currentIndex;
            var currentItem = castManager.queue.getCurrentItem();
            castManager.playNow(firstItemToInsert);
            setTimeout(function() {
              castManager.castMedia.media.contentId.should.equal(firstItemToInsert.url);
              castManager.queue.items[currentIndex].url.should.equal(firstItemToInsert.url);
              castManager.queue.items[currentIndex + 1].url.should.equal(currentItem.url);
              castManager.castMedia.playerState.should.equal(chrome.cast.media.PlayerState.PLAYING);
              done();
            }, castLongTimeout)
          });
        });

        describe('cast queue deletion tests', function() {

          it('queue size should be 20', function(){
            castManager.queue.items.should.have.a.lengthOf(20);
          });

          it('deleting a video should start the next video', function(done) {
            var nextItem = castManager.queue.peekNextItem();
            castManager.queueRemoveItem(castManager.queue.getCurrentItem());
            setTimeout(function() {
              castManager.castMedia.currentItemId.should.equal(nextItem.queueId);
              done();
            }, castLongTimeout);
          });

          it('playing the last video then deleting it should result in the splash screen', function(done) {
            var lastItem = castManager.queue.items[castManager.queue.getLength() - 1];
            castManager.queuePlayItem(lastItem);
            setTimeout(function() {
              castManager.queueRemoveItem(lastItem);
              setTimeout(function() {
                castManager.queue.items.should.not.containEql(lastItem);
                Should.not.exist(castManager.castMedia.currentItemId);
                castManager.hasCastMedia.should.be.false();
                done();
              }, castTimeout);
            }, castLongTimeout)
          });

          it('playNow should add a video to the end of the queue and start it', function(done) {
            var item = processedMediaArray[0];
            castManager.playNow(item);
            setTimeout(function() {
              castManager.castMedia.media.contentId.should.equal(item.url);
              castManager.queue.items.should.have.a.lengthOf(1);
              castManager.castMedia.playerState.should.equal(chrome.cast.media.PlayerState.PLAYING);
              done();
            }, castLongTimeout);
          });
        });

        describe('cast queue video play order tests', function() {
          var itemToMove, previousItem;

          before(function(done) {
            castManager.addItemsToQueue(processedMediaArray.slice(0, 5));
            setTimeout(function() {
              itemToMove = castManager.queue.items[castManager.queue.getLength()-2];
              done();
            }, castTimeout);
          });

          after(function() {
            castManager.stopCasting();
          });

          it('next video starts after seek to end of current video', function(done) {
            var nextItem = castManager.queue.peekNextItem();
            castManager.seek(castManager.localMedia.duration);
            setTimeout(function() {
              castManager.castMedia.currentItemId.should.equal(nextItem.queueId);
              castManager.localMedia.url.should.equal(nextItem.url);
              done();
            }, castLongTimeout);
          });

          it('queueMoveItemToNewIndex moves item', function(done) {
            var newIndex = castManager.queue.currentIndex + 1;
            previousItem = castManager.queue.items[newIndex];

            castManager.queueMoveItemToNewIndex(itemToMove.queueId, newIndex);
            setTimeout(function() {
              castManager.queue.items[newIndex].url.should.equal(itemToMove.url);
              done();
            }, castTimeout);
          });

          it('correct video starts after seek to end of current video', function(done) {
            castManager.seek(castManager.localMedia.duration);
            setTimeout(function() {
              castManager.castMedia.currentItemId.should.equal(itemToMove.queueId);
              done();
            }, castLongTimeout);
          });

          it('correct video starts after seek to end of moved video', function(done) {
            castManager.seek(castManager.localMedia.duration);
            setTimeout(function() {
              castManager.castMedia.currentItemId.should.equal(previousItem.queueId);
              done();
            }, castLongTimeout);
          });
        });
      }
    });
  });
</script>

</body>
</html>