<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="js/media.js"></script>
  <script src="js/mediastatus.js"></script>

  <link rel="import" href="bower_components/core-header-panel/core-header-panel.html">
  <link rel="import" href="elements/chromecast-video.html">
  <link rel="import" href="elements/video-details.html">
  <link rel="import" href="elements/video-carousel.html">
  <link rel="import" href="elements/chromecast-controller-bar.html">

  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" media="only screen and (min-width: 768px) and (max-width: 1223px)"
        href="css/mw-768-styles.css">
  <link rel="stylesheet" media="only screen and (min-width: 1224px) and (max-width: 1823px)"
        href="css/mw-1224-styles.css">
  <link rel="stylesheet" media="only screen and (min-width: 1724px)" href="css/mw-1724-styles.css">

  <script>
    var mediaList;
    var media;
    var mediaStatus;
    var ROOT = '//commondatastorage.googleapis.com/gtv-videos-bucket/sample/';
    var isPolymerReady = false;
    window.addEventListener('polymer-ready', function () {
      isPolymerReady = true;
    });

    // Create the XHR object.
    function createCORSRequest(method, url) {
      var xhr = new XMLHttpRequest();
      if ("withCredentials" in xhr) {
        // XHR for Chrome/Firefox/Opera/Safari.
        xhr.open(method, url, true);
      } else if (typeof XDomainRequest != "undefined") {
        // XDomainRequest for IE.
        xhr = new XDomainRequest();
        xhr.open(method, url);
      } else {
        // CORS not supported.
        xhr = null;
      }
      return xhr;
    }

    function makeCorsRequest() {
      var url = ROOT + 'd.json';
      var xhr = createCORSRequest('GET', url);
      if (!xhr) {
        alert('CORS not supported');
        return;
      }
      // Response handlers.
      xhr.onload = function() {
        var content = JSON.parse(xhr.responseText);
        mediaList = processMediaList(content);
        media = new cast.Media(mediaList[Object.keys(mediaList)[0]]);

        mediaStatus = new cast.MediaStatus(media);

        if (isPolymerReady){
          loadDataIntoPolymer(mediaStatus);
        } else {
          window.addEventListener('polymer-ready', function () {
            loadDataIntoPolymer(mediaStatus);
          });
        }

      };
      xhr.onerror = function() {
        alert('Woops, there was an error making the request.');
      };
      xhr.send();
    }
    function loadDataIntoPolymer(mediaStatus) {
      var videoPlayer = document.querySelector('chromecast-video');
      videoPlayer.mediaStatus = mediaStatus;
      var videoDetails = document.querySelector('video-details');
      videoDetails.mediaStatus = mediaStatus;
      var videoCarousels = document.querySelectorAll('video-carousel');
      for (var carousel in videoCarousels) {
        videoCarousels[carousel].mediaList = mediaList;
        videoCarousels[carousel].mediaStatus = mediaStatus;
      }
      var controllerBar = document.querySelector('chromecast-controller-bar');
      controllerBar.mediaStatus = mediaStatus;
    }
    function processMediaList(content) {
      var mediaList = {};
      var contentArray = content.categories[0].videos;
      for (var i = 0; i < contentArray.length; i++) {
        var title = contentArray[i].title.replace(/\s+/g, '-').toLowerCase();
        mediaList[title] = {
          'title' : contentArray[i].title,
          'description': contentArray[i].subtitle,
          'url': contentArray[i].sources[0],
          'studio': contentArray[i].studio,
          'thumbnailImageUrl': ROOT + contentArray[i]['image-480x270'],
          'largeImageUrl': ROOT + contentArray[i]['image-780x1200']
        };
      }
      return mediaList;
    }
    makeCorsRequest();

  </script>
</head>
<body fullbleed layout vertical>
<core-header-panel flex mode="seamed">
  <div class="core-header center-box-shadow width">
    <img src="images/logo.png">
  </div>
  <div class="center-box-shadow width bgcolor translate-hack">
    <div class="content">
      <chromecast-video appId="A1A660BF" class="video-width video-height shadow"></chromecast-video>
      <video-details class="video-width"></video-details>
    </div>
    <video-carousel genre="Movies" class="full-width"></video-carousel>
    <video-carousel genre="Comedy" class="full-width"></video-carousel>
    <video-carousel genre="Related Content" class="full-width"></video-carousel>
    <div id="footer" class="width"></div>
  </div>

</core-header-panel>
<chromecast-controller-bar></chromecast-controller-bar>
</body>
</html>
